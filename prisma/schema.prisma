// D:\NCHK\master_degree\tapchi_pdu\prisma\schema.prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["relationJoins"]
}

datasource db {
  provider     = "sqlserver"
  relationMode = "prisma"
}

model TaiKhoanNguoiDung {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("USER")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  magazines Magazine[]

  @@map("users")
}

model Magazine {
  id                  String             @id @default(cuid())
  tieuDe              String
  tenTacGia           String?
  moTa                String?
  anhBiaLocal         String?
  anhBiaUrl           String?
  fileUpload          File?              @relation(fields: [fileUploadId], references: [id])
  fileUploadId        String?
  trangThai           String             @default("draft")
  ngayXuatBan         DateTime?
  TaiKhoanNguoiDung   TaiKhoanNguoiDung? @relation(fields: [taiKhoanNguoiDungId], references: [id])
  taiKhoanNguoiDungId String?
  categoryName        Category[]         @relation("MagazineCategories")
  major               Major[]            @relation("MagazineMajors")
  readCount           Int                @default(0)
  likeCount           Int                @default(0)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  // NEW: Relation to pages
  pages Page[]

  @@index([fileUploadId])
  @@index([taiKhoanNguoiDungId])
}

// NEW: Page model for storing converted PDF pages
model Page {
  id         String   @id @default(cuid())
  magazineId String
  magazine   Magazine @relation(fields: [magazineId], references: [id], onDelete: Cascade)
  pageNumber Int
  imageUrl   String // URL to the converted image
  content    String? // Optional text content
  createdAt  DateTime @default(now())

  @@unique([magazineId, pageNumber])
  @@index([magazineId])
}

model Category {
  id        String     @id @default(cuid())
  name      String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  magazines Magazine[] @relation("MagazineCategories")
}

model Major {
  id        String     @id @default(cuid())
  name      String     @unique
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  magazines Magazine[] @relation("MagazineMajors")
}

model File {
  id        String     @id @default(cuid())
  fileName  String
  fileType  String
  fileUrl   String
  createdAt DateTime   @default(now())
  Magazine  Magazine[]
}
